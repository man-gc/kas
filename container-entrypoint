#!/bin/sh
#
# kas - setup tool for bitbake based projects
#
# Copyright (c) Siemens AG, 2017-2023
#
# SPDX-License-Identifier: MIT

# kas-isar: sudo update-binfmts --enable && [ -f /proc/sys/fs/binfmt_misc/status ]

if mount | grep -q "on / type aufs"; then
    cat <<EOF >&2
WARNING: Generation of wic images will fail!

Your docker host setup uses broken aufs as storage driver. Adjust the docker
configuration to use a different driver (overlay, overlay2, devicemapper). You
may also need to update the host distribution (e.g. Debian Jessie -> Stretch).

EOF
fi

if [ -z "$USER_ID" ]; then
	# Not a kas-container call
	GOSU=""

	# Work around gitlab-runner not aligning checked out repo ownership
	# with our builder user
	sudo git config --system safe.directory "*"
elif [ "$USER_ID" = 0 ]; then
	# We shall run everything as root
	GOSU=""
else
	GROUP_ID=${GROUP_ID:-$(id -g)}

	groupmod -o --gid "$GROUP_ID" builder
	usermod -o --uid "$USER_ID" --gid "$GROUP_ID" builder >/dev/null
	chown -R "$USER_ID":"$GROUP_ID" /builder
	# copy host SSH config into home of builder
	if [ -d /var/kas/userdata/.ssh ]; then
		cp -a /var/kas/userdata/.ssh /builder/
	fi

	GOSU="gosu builder"
fi

if [ "$PWD" = / ]; then
	cd /builder || exit 1
fi

if [ -n "$1" ]; then
	case "$1" in
	build|checkout|dump|for-all-repos|menu|shell|-*)
		# SC2086: Double quote to prevent globbing and word splitting.
		# shellcheck disable=2086
		exec $GOSU kas "$@"
		;;
	*)
		# SC2086: Double quote to prevent globbing and word splitting.
		# shellcheck disable=2086
		exec $GOSU "$@"
		;;
	esac
else
	# SC2086: Double quote to prevent globbing and word splitting.
	# shellcheck disable=2086
	exec $GOSU bash
fi
